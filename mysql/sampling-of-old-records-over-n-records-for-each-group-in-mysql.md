[&larr;](readme.md "MySQL") Выборка старых записей сверх n-записей для каждой группы в MySQL
--------------------------------------------------------------------------------------------

<a name="content"></a>
## Содержание

- [Описание](#description)
- [Структура таблиц](#structure-of-tables)
  - [Таблица `groups`](#table-groups)
  - [Дамп базы данных](#database-dump)
- [SQL-запрос](#sql-query)
- [Запрос для Laravel](#request-for-laravel)
- [Результат](#result)
- [Источники](#sources)

<a name="description"></a>
## Описание

Выборка старых записей сверх n-записей (в данном примере сверх 2х записей) для каждой группы. Может применяться для удаления старых записей, количество которых превышает n-записей (в данном примере более 2х записей) для каждой группы.

<a name="structure-of-tables"></a>
## Структура таблиц

<a name="table-groups"></a>
### Таблица `groups`

id | group | text | created_at | updated_at
:---: | --- | --- | :---: | :---:
1 | Группа 1 | Текст 1 | 2022-01-01 12:00:00 | 2022-01-01 12:00:00
2 | Группа 1 | Текст 2 | 2022-01-02 12:00:00 | 2022-01-02 12:00:00
3 | Группа 1 | Текст 3 | 2022-01-03 12:00:00 | 2022-01-03 12:00:00
4 | Группа 1 | Текст 4 | 2022-01-04 12:00:00 | 2022-01-04 12:00:00
5 | Группа 2 | Текст 5 | 2022-01-05 12:00:00 | 2022-01-05 12:00:00
6 | Группа 2 | Текст 6 | 2022-01-06 12:00:00 | 2022-01-06 12:00:00
7 | Группа 2 | Текст 7 | 2022-01-07 12:00:00 | 2022-01-07 12:00:00
8 | Группа 3 | Текст 8 | 2022-01-08 12:00:00 | 2022-01-08 12:00:00
9 | Группа 3 | Текст 9 | 2022-01-09 12:00:00 | 2022-01-09 12:00:00

<a name="database-dump"></a>
### Дамп базы данных

<details>
<summary><i>Дамп базы данных</i></summary>

```
--
-- Структура таблицы `groups`
--

DROP TABLE IF EXISTS `groups`;
CREATE TABLE IF NOT EXISTS `groups` (
`id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
`group` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '',
`text` varchar(255) COLLATE utf8mb4_unicode_ci,
`created_at` timestamp NULL DEFAULT NULL,
`updated_at` timestamp NULL DEFAULT NULL,
PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Дамп данных таблицы `groups`
--

INSERT INTO `groups` (`id`, `group`, `text`, `created_at`, `updated_at`) VALUES
(1, 'Группа 1', 'Текст 1', '2022-01-01 12:00:00', '2022-01-01 12:00:00'),
(2, 'Группа 1', 'Текст 2', '2022-01-02 12:00:00', '2022-01-02 12:00:00'),
(3, 'Группа 1', 'Текст 3', '2022-01-03 12:00:00', '2022-01-03 12:00:00'),
(4, 'Группа 1', 'Текст 4', '2022-01-04 12:00:00', '2022-01-04 12:00:00'),
(5, 'Группа 2', 'Текст 5', '2022-01-05 12:00:00', '2022-01-05 12:00:00'),
(6, 'Группа 2', 'Текст 6', '2022-01-06 12:00:00', '2022-01-06 12:00:00'),
(7, 'Группа 2', 'Текст 7', '2022-01-07 12:00:00', '2022-01-07 12:00:00'),
(8, 'Группа 3', 'Текст 8', '2022-01-08 12:00:00', '2022-01-08 12:00:00'),
(9, 'Группа 3', 'Текст 9', '2022-01-09 12:00:00', '2022-01-09 12:00:00');
```
</details>

<a name="sql-query"></a>
## SQL-запрос

```sql
SELECT
	`t1`.* 
FROM
	`groups` AS `t1`
	INNER JOIN `groups` AS `t2` ON `t1`.`group` = `t2`.`group` 
	AND `t1`.`created_at` <= `t2`.`created_at` 
GROUP BY
	`t1`.`id` 
HAVING
	COUNT(*) > 2
```

<a name="request-for-laravel"></a>
## Запрос для Laravel

```php
DB::table('groups as t1')
    ->select('t1.*')
    ->join('groups as t2', function($query) {
        $query->on('t1.group', '=', 't2.group')
            ->on('t1.created_at', '<=', 't2.created_at');
    })
    ->groupBy('t1.id')
    ->havingRaw('COUNT(*) > 2');
```

<a name="result"></a>
## Результат

id | group | text | created_at | updated_at
:---: | --- | --- | :---: | :---:
1 | Группа 1 | Текст 1 | 2022-01-01 12:00:00 | 2022-01-01 12:00:00
2 | Группа 1 | Текст 2 | 2022-01-02 12:00:00 | 2022-01-02 12:00:00
5 | Группа 2 | Текст 5 | 2022-01-05 12:00:00 | 2022-01-05 12:00:00

<a name="sources"></a>
## Источники

- [Выбрать несколько записей из каждой группы. (sqlinfo.ru)](https://sqlinfo.ru/articles/info/45.html)